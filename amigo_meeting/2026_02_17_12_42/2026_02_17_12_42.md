# 3 Amigos Meeting Notes â€” ç™»å…¥èˆ‡è¨»å†ŠåŠŸèƒ½

> **Date**: 2026-02-17
> **Requirement Source**: 1. å®Œå–„ "ç™»å…¥" åŠŸèƒ½ 2. æ–°å¢ "è¨»å†Š" åŠŸèƒ½ï¼Œä½¿ç”¨è€…å¯ä»¥ç”¨ Google å¸³è™Ÿç™»å…¥

---

## 0. Original Requirement

1. å®Œå–„ "ç™»å…¥" åŠŸèƒ½
2. æ–°å¢ "è¨»å†Š" åŠŸèƒ½ï¼Œä½¿ç”¨è€…å¯ä»¥ç”¨ Google å¸³è™Ÿç™»å…¥

---

## 1. Product Owner Analysis

### ğŸ’­ Thinking Process

- ç›®å‰ LoginView.vue åªæœ‰ "Coming Soon" ä½”ä½ï¼ŒLoginButton.vue ç”¨ç¡¬ç·¨ç¢¼ `isAuthenticated = ref(false)`ï¼Œå¾Œç«¯åªæœ‰ health check â€” ç­‰æ–¼èªè­‰åŠŸèƒ½å®Œå…¨æœªå¯¦ä½œã€‚
- ä½¿ç”¨è€…æåˆ°ã€ŒGoogle å¸³è™Ÿç™»å…¥ã€ï¼Œé€™ä»£è¡¨éœ€è¦ OAuth 2.0 ç¤¾äº¤ç™»å…¥ã€‚ä½†ã€Œè¨»å†Šã€å’Œã€Œç™»å…¥ã€åœ¨ Google OAuth æµç¨‹ä¸­å…¶å¯¦æ˜¯åŒä¸€å€‹å‹•ä½œï¼ˆé¦–æ¬¡æˆæ¬Šå³è‡ªå‹•è¨»å†Šï¼‰ï¼Œéœ€è¦é‡æ¸…æ˜¯å¦ä¹Ÿéœ€è¦ Email/å¯†ç¢¼çš„å‚³çµ±è¨»å†Šã€‚
- ç›®æ¨™ç”¨æˆ¶æ˜¯ç¹é«”ä¸­æ–‡ä½¿ç”¨è€…ï¼ˆzh-Hantï¼‰ï¼Œé€™æ˜¯ä¸€å€‹æ”¯ä»˜æ‡‰ç”¨ï¼Œå®‰å…¨æ€§æ˜¯æ ¸å¿ƒé—œæ³¨é»ã€‚
- MVP æ€ç¶­ï¼šå…ˆåš Google OAuth ç™»å…¥/è¨»å†Šï¼ˆä¸€å€‹æŒ‰éˆ•è§£æ±ºå…©ä»¶äº‹ï¼‰ï¼Œå†è€ƒæ…®å‚³çµ± Email/å¯†ç¢¼ã€‚

### 1.1 Clarifying Questions & Assumptions

**Questions**ï¼ˆä»¥å‡è¨­å›ç­”ï¼‰ï¼š
1. æ˜¯å¦éœ€è¦å‚³çµ± Email/å¯†ç¢¼è¨»å†Šï¼Œé‚„æ˜¯åªç”¨ Google OAuthï¼Ÿ â†’ å‡è¨­ï¼š**MVP åƒ…æ”¯æ´ Google OAuth**ï¼ŒEmail/å¯†ç¢¼ç‚ºå¾ŒçºŒè¿­ä»£
2. ç™»å…¥å¾Œè¦å°å‘å“ªå€‹é é¢ï¼Ÿ â†’ å‡è¨­ï¼šå°å›é¦–é ï¼ŒHeader é¡¯ç¤ºä½¿ç”¨è€…é ­åƒ/åç¨±
3. æ˜¯å¦éœ€è¦è§’è‰²/æ¬Šé™æ©Ÿåˆ¶ï¼Ÿ â†’ å‡è¨­ï¼šMVP ä¸éœ€è¦ï¼Œæ‰€æœ‰ä½¿ç”¨è€…æ¬Šé™ç›¸åŒ
4. Token å­˜æ”¾ç­–ç•¥ï¼Ÿ â†’ å‡è¨­ï¼šä½¿ç”¨ HttpOnly Cookie å­˜æ”¾ JWTï¼ˆæ”¯ä»˜æ‡‰ç”¨å®‰å…¨æ€§è€ƒé‡ï¼‰

**Key Assumptionsï¼š**
- Google OAuth 2.0 Authorization Code Flowï¼ˆå¾Œç«¯äº¤æ› tokenï¼Œéå‰ç«¯éš±å¼æµç¨‹ï¼‰
- é¦–æ¬¡ Google ç™»å…¥å³è‡ªå‹•å»ºç«‹å¸³æˆ¶ï¼ˆç™»å…¥ = è¨»å†Šï¼‰
- ä½¿ç”¨è€…è³‡æ–™åƒ…å­˜ï¼šGoogle IDã€Emailã€åç¨±ã€é ­åƒ URL
- JWT å­˜æ”¾åœ¨ HttpOnly Cookieï¼Œå‰ç«¯ä¸ç›´æ¥æ¥è§¸ token

### 1.2 Epic / Feature Breakdown

**Epic**: ä½¿ç”¨è€…èªè­‰ç³»çµ±

- **Feature 1**: Google OAuth ç™»å…¥/è¨»å†Š
- **Feature 2**: èªè­‰ç‹€æ…‹ç®¡ç†ï¼ˆå‰ç«¯æŒä¹…åŒ–ã€Header ç‹€æ…‹åˆ‡æ›ï¼‰
- **Feature 3**: ç™»å‡ºåŠŸèƒ½

### 1.3 User Stories

#### Story 1: Google OAuth ç™»å…¥/è¨»å†Š
> **As a** è¨ªå®¢ï¼Œ**I want** é€é Google å¸³è™Ÿä¸€éµç™»å…¥æˆ–è¨»å†Šï¼Œ**so that** æˆ‘ä¸éœ€è¦è¨˜ä½é¡å¤–çš„å¯†ç¢¼å°±èƒ½ä½¿ç”¨ MeowMeowPayã€‚

**INVEST Check**: âœ… Independent | âœ… Negotiable | âœ… Valuable | âœ… Estimable | âœ… Small | âœ… Testable

#### Story 2: èªè­‰ç‹€æ…‹é¡¯ç¤º
> **As a** å·²ç™»å…¥ä½¿ç”¨è€…ï¼Œ**I want** åœ¨é é¢ Header çœ‹åˆ°æˆ‘çš„ Google é ­åƒèˆ‡åç¨±ï¼Œ**so that** æˆ‘çŸ¥é“è‡ªå·±å·²æˆåŠŸç™»å…¥ã€‚

**INVEST Check**: âœ… Independent | âœ… Negotiable | âœ… Valuable | âœ… Estimable | âœ… Small | âœ… Testable

#### Story 3: ç™»å‡º
> **As a** å·²ç™»å…¥ä½¿ç”¨è€…ï¼Œ**I want** èƒ½å¤ ç™»å‡ºå¸³è™Ÿï¼Œ**so that** æˆ‘å¯ä»¥åœ¨å…±ç”¨è£ç½®ä¸Šä¿è­·æˆ‘çš„å¸³æˆ¶å®‰å…¨ã€‚

**INVEST Check**: âœ… Independent | âœ… Negotiable | âœ… Valuable | âœ… Estimable | âœ… Small | âœ… Testable

### 1.4 Acceptance Criteria

**Story 1: Google OAuth ç™»å…¥/è¨»å†Š**
```gherkin
Scenario: é¦–æ¬¡ Google ç™»å…¥ï¼ˆè‡ªå‹•è¨»å†Šï¼‰
  Given æˆ‘æ˜¯ä¸€å€‹æœªè¨»å†Šçš„è¨ªå®¢ï¼Œåœ¨ç™»å…¥é é¢
  When æˆ‘é»æ“Šã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€æŒ‰éˆ•
  And æˆ‘åœ¨ Google æˆæ¬Šé é¢åŒæ„æˆæ¬Š
  Then ç³»çµ±è‡ªå‹•ç‚ºæˆ‘å»ºç«‹å¸³è™Ÿ
  And æˆ‘è¢«å°å›é¦–é 
  And Header é¡¯ç¤ºæˆ‘çš„ Google åç¨±å’Œé ­åƒ

Scenario: å·²è¨»å†Šä½¿ç”¨è€… Google ç™»å…¥
  Given æˆ‘æ˜¯å·²è¨»å†Šä½¿ç”¨è€…ï¼Œåœ¨ç™»å…¥é é¢
  When æˆ‘é»æ“Šã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€æŒ‰éˆ•
  And æˆ‘åœ¨ Google æˆæ¬Šé é¢åŒæ„æˆæ¬Š
  Then æˆ‘è¢«å°å›é¦–é 
  And Header é¡¯ç¤ºæˆ‘çš„ Google åç¨±å’Œé ­åƒ

Scenario: ä½¿ç”¨è€…æ‹’çµ• Google æˆæ¬Š
  Given æˆ‘åœ¨ç™»å…¥é é¢
  When æˆ‘é»æ“Šã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€æŒ‰éˆ•
  And æˆ‘åœ¨ Google æˆæ¬Šé é¢å–æ¶ˆæˆæ¬Š
  Then æˆ‘è¢«å°å›ç™»å…¥é é¢
  And é¡¯ç¤ºã€Œç™»å…¥å·²å–æ¶ˆã€çš„æç¤ºè¨Šæ¯
```

**Story 2: èªè­‰ç‹€æ…‹é¡¯ç¤º**
```gherkin
Scenario: å·²ç™»å…¥ä½¿ç”¨è€…çœ‹åˆ°è‡ªå·±çš„è³‡è¨Š
  Given æˆ‘å·²é€é Google ç™»å…¥
  When æˆ‘ç€è¦½ä»»ä½•é é¢
  Then Header é¡¯ç¤ºæˆ‘çš„ Google é ­åƒå’Œåç¨±
  And ã€Œç™»å…¥ã€æŒ‰éˆ•è¢«æ›¿æ›ç‚ºä½¿ç”¨è€…é¸å–®

Scenario: é‡æ–°æ•´ç†é é¢å¾Œä»ä¿æŒç™»å…¥
  Given æˆ‘å·²é€é Google ç™»å…¥
  When æˆ‘é‡æ–°æ•´ç†é é¢
  Then æˆ‘ä»ç„¶ä¿æŒç™»å…¥ç‹€æ…‹
  And Header ä¾ç„¶é¡¯ç¤ºæˆ‘çš„è³‡è¨Š
```

**Story 3: ç™»å‡º**
```gherkin
Scenario: ä½¿ç”¨è€…ç™»å‡º
  Given æˆ‘å·²ç™»å…¥
  When æˆ‘é»æ“Šä½¿ç”¨è€…é¸å–®ä¸­çš„ã€Œç™»å‡ºã€
  Then æˆ‘çš„ç™»å…¥ç‹€æ…‹è¢«æ¸…é™¤
  And Header æ¢å¾©é¡¯ç¤ºã€Œç™»å…¥ã€æŒ‰éˆ•
  And æˆ‘è¢«å°å›é¦–é 
```

### 1.5 Prioritization (MoSCoW)

| Priority | Story | Rationale |
|----------|-------|-----------|
| Must | Story 1: Google OAuth ç™»å…¥/è¨»å†Š | æ ¸å¿ƒåŠŸèƒ½ï¼Œç„¡æ­¤å‰‡ç„¡æ³•ä½¿ç”¨ä»»ä½•éœ€èªè­‰çš„åŠŸèƒ½ |
| Must | Story 2: èªè­‰ç‹€æ…‹é¡¯ç¤º | ç™»å…¥å¾Œçš„åŸºæœ¬ UX å›é¥‹ |
| Must | Story 3: ç™»å‡º | å®‰å…¨æ€§åŸºæœ¬éœ€æ±‚ï¼Œå°¤å…¶æ˜¯æ”¯ä»˜æ‡‰ç”¨ |

---

## 2. Frontend Engineer Analysis

### ğŸ’­ Thinking Process

- ç›®å‰ LoginView.vue æ˜¯ç©ºæ®¼ï¼Œéœ€è¦æ”¹é€ ç‚º Google OAuth å…¥å£é é¢ã€‚ä¸éœ€è¦å‚³çµ±è¡¨å–®ï¼Œåªéœ€è¦ä¸€å€‹ã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€çš„ CTA æŒ‰éˆ•ã€‚
- LoginButton.vue çš„ `isAuthenticated` ç›®å‰æ˜¯ç¡¬ç·¨ç¢¼ `false`ï¼Œéœ€è¦æ”¹ç‚ºå¾å…¨åŸŸèªè­‰ç‹€æ…‹è®€å–ã€‚
- èªè­‰ç‹€æ…‹éœ€è¦å…¨åŸŸç®¡ç† â€” è€ƒæ…®ç”¨ Vue composableï¼ˆ`useAuth`ï¼‰è€Œéå¼•å…¥ Piniaï¼Œå› ç‚ºå°ˆæ¡ˆç›®å‰æ²’æœ‰ç”¨ç‹€æ…‹ç®¡ç†åº«ï¼Œä¸”èªè­‰ç‹€æ…‹ç›¸å°ç°¡å–®ã€‚
- Google OAuth æµç¨‹ï¼šå‰ç«¯åªè² è²¬é‡å°å‘åˆ°å¾Œç«¯çš„ OAuth èµ·å§‹ URLï¼Œå¾Œç«¯è™•ç†å®Œ callback å¾Œè¨­å®š Cookie å†é‡å°å‘å›å‰ç«¯ã€‚å‰ç«¯ä¸ç›´æ¥èˆ‡ Google API äº’å‹•ã€‚
- éœ€è¦ä¸€å€‹ `/api/auth/me` ç«¯é»è®“å‰ç«¯åœ¨é é¢è¼‰å…¥æ™‚ç¢ºèªç™»å…¥ç‹€æ…‹ã€‚

### 2.1 UI/UX Breakdown

**Pages / Views:**
- **LoginView**ï¼ˆæ”¹é€ ç¾æœ‰ï¼‰ï¼šGoogle OAuth ç™»å…¥é é¢ï¼Œå“ç‰Œè¦–è¦º + ä¸€å€‹ã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€æŒ‰éˆ•
- **OAuthCallbackView**ï¼ˆæ–°å¢ï¼‰ï¼šOAuth callback ä¸­é–“é ï¼Œé¡¯ç¤ºã€Œç™»å…¥ä¸­...ã€è™•ç†å›å‚³çµæœ

**Components:**

| Component | Type | Description |
|-----------|------|-------------|
| LoginButton | æ”¹é€ ç¾æœ‰ | å¾ `useAuth` è®€å–èªè­‰ç‹€æ…‹ï¼Œå·²ç™»å…¥æ™‚é¡¯ç¤º UserMenu |
| GoogleLoginButton | æ–°å¢ | Google å“ç‰Œé¢¨æ ¼ç™»å…¥æŒ‰éˆ•ï¼Œé»æ“Šå¾Œé‡å°å‘è‡³å¾Œç«¯ OAuth URL |
| UserMenu | æ–°å¢ | é¡¯ç¤ºä½¿ç”¨è€…é ­åƒ/åç¨±ï¼Œé»æ“Šå±•é–‹ä¸‹æ‹‰é¸å–®ï¼ˆå«ç™»å‡ºï¼‰ |
| UserAvatar | æ–°å¢ | é¡¯ç¤º Google é ­åƒçš„åœ“å½¢ avatar å…ƒä»¶ |

**User Flow:**

1. è¨ªå®¢é»æ“Š Headerã€Œç™»å…¥ã€â†’ å°å‘ `/login`
2. åœ¨ LoginView é»æ“Šã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€â†’ é‡å°å‘è‡³ `GET /api/auth/google`ï¼ˆå¾Œç«¯ç”¢ç”Ÿ Google OAuth URL ä¸¦ 302 redirectï¼‰
3. ä½¿ç”¨è€…åœ¨ Google åŒæ„æˆæ¬Š â†’ Google callback è‡³ `GET /api/auth/google/callback`
4. å¾Œç«¯é©—è­‰ã€å»ºç«‹/æŸ¥æ‰¾ä½¿ç”¨è€…ã€è¨­å®š JWT Cookie â†’ 302 é‡å°å‘è‡³å‰ç«¯ `/`
5. å‰ç«¯é¦–é è¼‰å…¥ â†’ `useAuth` å‘¼å« `GET /api/auth/me` â†’ å–å¾—ä½¿ç”¨è€…è³‡è¨Š â†’ Header æ›´æ–°

### 2.2 State Management

| State | Scope | Source | Triggers |
|-------|-------|--------|----------|
| `user` | Global (composable) | `GET /api/auth/me` | é é¢è¼‰å…¥ã€ç™»å…¥æˆåŠŸå¾Œ |
| `isAuthenticated` | Global (computed) | ç”± `user` è¡ç”Ÿ | `user` æ”¹è®Šæ™‚ |
| `isLoading` | Global (composable) | API è«‹æ±‚ä¸­ | auth/me è«‹æ±‚é–‹å§‹/çµæŸ |
| `showUserMenu` | Local (UserMenu) | ä½¿ç”¨è€…é»æ“Š | é»æ“Š avatar å±•é–‹/æ”¶åˆ |

### 2.3 API Contract Expectations

| Endpoint | Method | Request | Response | Notes |
|----------|--------|---------|----------|-------|
| `/api/auth/google` | GET | â€” | 302 redirect è‡³ Google | å‰ç«¯ç›´æ¥ `window.location.href` |
| `/api/auth/google/callback` | GET | query: `code`, `state` | 302 redirect è‡³å‰ç«¯é¦–é  | å¾Œç«¯è™•ç†ï¼Œè¨­å®š HttpOnly Cookie |
| `/api/auth/me` | GET | Cookie (è‡ªå‹•å¸¶) | `{ id, email, name, avatar_url }` | æœªç™»å…¥å› 401 |
| `/api/auth/logout` | POST | Cookie (è‡ªå‹•å¸¶) | `{ message: "ok" }` | æ¸…é™¤ Cookie |

### 2.4 Task Breakdown

| # | Task | Story | Estimate |
|---|------|-------|----------|
| FE-1 | å»ºç«‹ `useAuth` composableï¼ˆuser stateã€fetchUserã€logout æ–¹æ³•ï¼‰ | Story 1, 2, 3 | M |
| FE-2 | å»ºç«‹ `api.js` HTTP client wrapperï¼ˆbase URLã€credentials includeï¼‰ | Story 1 | S |
| FE-3 | æ”¹é€  LoginViewï¼šç§»é™¤ä½”ä½å…§å®¹ï¼ŒåŠ å…¥å“ç‰Œè¦–è¦º + GoogleLoginButton | Story 1 | M |
| FE-4 | å»ºç«‹ GoogleLoginButton å…ƒä»¶ï¼ˆGoogle å“ç‰Œæ¨£å¼ï¼‰ | Story 1 | S |
| FE-5 | æ”¹é€  LoginButton â†’ ä¾æ“šèªè­‰ç‹€æ…‹åˆ‡æ›é¡¯ç¤ºã€Œç™»å…¥ã€æˆ– UserMenu | Story 2 | S |
| FE-6 | å»ºç«‹ UserMenu å…ƒä»¶ï¼ˆé ­åƒã€åç¨±ã€ç™»å‡ºä¸‹æ‹‰é¸å–®ï¼‰ | Story 2, 3 | M |
| FE-7 | å»ºç«‹ UserAvatar å…ƒä»¶ | Story 2 | S |
| FE-8 | åœ¨ App.vue æˆ– router beforeEach åŠ å…¥ auth åˆå§‹åŒ–ï¼ˆé é¢è¼‰å…¥æ™‚ fetchUserï¼‰ | Story 2 | S |
| FE-9 | æ–°å¢ routerï¼š`/auth/callback` route + OAuthCallbackView | Story 1 | S |
| FE-10 | éŒ¯èª¤è™•ç†ï¼šOAuth å¤±æ•—/å–æ¶ˆçš„æç¤ºè¨Šæ¯ | Story 1 | S |

---

## 3. Backend Engineer Analysis

### ğŸ’­ Thinking Process

- æ”¯ä»˜æ‡‰ç”¨çš„èªè­‰éœ€è¦åš´è¬¹å°å¾…ã€‚Google OAuth ä½¿ç”¨ Authorization Code Flow â€” å¾Œç«¯æŒæœ‰ client secretï¼Œå‰ç«¯æ°¸é ä¸ç¢° tokenã€‚
- è³‡æ–™æ¨¡å‹ç°¡å–®ï¼šä¸€å¼µ `users` è¡¨å­˜ Google OAuth è³‡è¨Šã€‚MVP ä¸éœ€è¦è¤‡é›œçš„è§’è‰²æ¬Šé™ã€‚
- JWT æ”¾åœ¨ HttpOnly Cookie è€Œé Authorization headerï¼Œé˜²æ­¢ XSS ç«Šå– tokenã€‚
- é¸ç”¨ PostgreSQL + SQLAlchemy â€” æ”¯ä»˜æ‡‰ç”¨éœ€è¦å¯é çš„ä¸¦ç™¼å¯«å…¥èˆ‡ ACID ä¿è­‰ï¼Œä¸”éƒ¨ç½²åˆ° Zeabur æ™‚è³‡æ–™ç¨ç«‹æ–¼å®¹å™¨ï¼Œä¸æœƒå› é‡å•Ÿéºå¤±ã€‚å¦éœ€ python-joseï¼ˆJWTï¼‰ã€httpxï¼ˆå‘¼å« Google APIï¼‰ã€‚
- éœ€åœ¨ Google Cloud Console è¨­å®š OAuth 2.0 Client IDï¼Œå–å¾— `GOOGLE_CLIENT_ID` å’Œ `GOOGLE_CLIENT_SECRET`ã€‚

### 3.1 API Design

| Endpoint | Method | Description | Request Body | Response | Status Codes |
|----------|--------|-------------|--------------|----------|--------------|
| `GET /api/auth/google` | GET | ç”¢ç”Ÿ Google OAuth URL ä¸¦é‡å°å‘ | â€” | 302 â†’ Google OAuth | 302 |
| `GET /api/auth/google/callback` | GET | Google OAuth callbackï¼Œé©—è­‰ codeã€å»ºç«‹/æŸ¥æ‰¾ä½¿ç”¨è€…ã€ç™¼ JWT | query: `code`, `state` | 302 â†’ å‰ç«¯é¦–é ï¼ˆSet-Cookieï¼‰ | 302, 400 |
| `GET /api/auth/me` | GET | å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š | Cookie | `{ id, email, name, avatar_url }` | 200, 401 |
| `POST /api/auth/logout` | POST | ç™»å‡ºï¼ˆæ¸…é™¤ Cookieï¼‰ | Cookie | `{ message: "logged out" }` | 200 |

### 3.2 Data Model / Database Changes

**è³‡æ–™åº«ï¼šPostgreSQL**ï¼ˆé–‹ç™¼èˆ‡æ­£å¼ç’°å¢ƒçµ±ä¸€ä½¿ç”¨ï¼Œé€é Zeabur PostgreSQL æœå‹™æˆ–æœ¬æ©Ÿ Docker/brewï¼‰

**New Tables:**
```
users
â”œâ”€â”€ id (UUID, PK) â€” PostgreSQL åŸç”Ÿ UUID å‹åˆ¥
â”œâ”€â”€ google_id (VARCHAR, UNIQUE, NOT NULL) â€” Google sub claim
â”œâ”€â”€ email (VARCHAR, UNIQUE, NOT NULL)
â”œâ”€â”€ name (VARCHAR, NOT NULL) â€” Google é¡¯ç¤ºåç¨±
â”œâ”€â”€ avatar_url (VARCHAR, NULLABLE) â€” Google é ­åƒ URL
â”œâ”€â”€ created_at (TIMESTAMP WITH TIME ZONE, DEFAULT NOW)
â””â”€â”€ updated_at (TIMESTAMP WITH TIME ZONE, DEFAULT NOW)
```

**ä¸éœ€è¦ sessions è¡¨** â€” ä½¿ç”¨ stateless JWTï¼ŒJWT éæœŸå³éœ€é‡æ–°ç™»å…¥ã€‚

### 3.3 Business Logic & Service Layer

- **Google OAuth Flow**ï¼š
  1. `GET /api/auth/google` â†’ ç”¢ç”Ÿå« `state`ï¼ˆCSRF é˜²è­·ï¼‰çš„ Google OAuth URL â†’ 302 redirect
  2. Google callback â†’ é©—è­‰ `state` â†’ ç”¨ `code` å‘ Google æ›å– `access_token` â†’ ç”¨ `access_token` å–å¾— userinfo â†’ æŸ¥æ‰¾æˆ–å»ºç«‹ä½¿ç”¨è€… â†’ ç°½ç™¼ JWT â†’ Set-Cookie â†’ 302 redirect è‡³å‰ç«¯

- **JWT ç°½ç™¼è¦å‰‡**ï¼š
  - Payload: `{ sub: user.id, exp: now + 7d }`
  - ç°½ç™¼æ¼”ç®—æ³•ï¼šHS256
  - Secret: ç’°å¢ƒè®Šæ•¸ `JWT_SECRET`

- **Cookie è¨­å®š**ï¼š
  - `HttpOnly: true`ï¼ˆJS ç„¡æ³•å­˜å–ï¼‰
  - `Secure: true`ï¼ˆç”Ÿç”¢ç’°å¢ƒ HTTPS onlyï¼‰
  - `SameSite: Lax`
  - `Max-Age: 7 days`

- **ä½¿ç”¨è€…æŸ¥æ‰¾/å»ºç«‹é‚è¼¯**ï¼š
  - ä»¥ `google_id` æŸ¥æ‰¾ â†’ æ‰¾åˆ°å‰‡æ›´æ–° name/avatar â†’ æ‰¾ä¸åˆ°å‰‡ INSERT æ–°ä½¿ç”¨è€…

### 3.4 Task Breakdown

| # | Task | Story | Estimate |
|---|------|-------|----------|
| BE-1 | è¨­å®š PostgreSQL + SQLAlchemyï¼Œå»ºç«‹ DB é€£ç·šèˆ‡ session ç®¡ç† | åŸºç¤å»ºè¨­ | M |
| BE-2 | å»ºç«‹ User modelï¼ˆSQLAlchemy ORMï¼‰ | åŸºç¤å»ºè¨­ | S |
| BE-3 | å»ºç«‹ `.env` é…ç½®ç®¡ç†ï¼ˆGOOGLE_CLIENT_IDã€GOOGLE_CLIENT_SECRETã€JWT_SECRETï¼‰ | åŸºç¤å»ºè¨­ | S |
| BE-4 | å¯¦ä½œ `GET /api/auth/google` â€” ç”¢ç”Ÿ OAuth URL + state + redirect | Story 1 | M |
| BE-5 | å¯¦ä½œ `GET /api/auth/google/callback` â€” é©—è­‰ codeã€å–å¾— userinfoã€å»ºç«‹/æŸ¥æ‰¾ä½¿ç”¨è€…ã€ç°½ç™¼ JWT Cookie | Story 1 | L |
| BE-6 | å¯¦ä½œ JWT å·¥å…·ï¼ˆç°½ç™¼ã€é©—è­‰ã€å¾ Cookie æå–ï¼‰ | Story 1, 2 | M |
| BE-7 | å¯¦ä½œ `GET /api/auth/me` â€” å¾ JWT å–å¾—ä½¿ç”¨è€…è³‡è¨Š | Story 2 | S |
| BE-8 | å¯¦ä½œ `POST /api/auth/logout` â€” æ¸…é™¤ Cookie | Story 3 | S |
| BE-9 | å»ºç«‹èªè­‰ä¾è³´é …ï¼ˆFastAPI Dependsï¼‰ç”¨æ–¼ä¿è­·è·¯ç”± | Story 2 | S |
| BE-10 | æ–°å¢ requirements.txt ä¾è³´ï¼šsqlalchemyã€psycopg2-binaryã€python-joseã€httpxã€python-dotenv | åŸºç¤å»ºè¨­ | S |

---

## 4. Test Engineer Analysis

### ğŸ’­ Thinking Process

- é€™æ˜¯ä¸€å€‹æ”¯ä»˜æ‡‰ç”¨çš„èªè­‰æ¨¡çµ„ï¼Œæ¸¬è©¦é‡é»åœ¨**å®‰å…¨æ€§**å’Œ**OAuth æµç¨‹æ­£ç¢ºæ€§**ã€‚
- OAuth æµç¨‹æ¶‰åŠç¬¬ä¸‰æ–¹ï¼ˆGoogleï¼‰ï¼Œæ•´åˆæ¸¬è©¦éœ€è¦ mock Google API å›æ‡‰ã€‚
- å‰ç«¯æ¸¬è©¦é‡é»ï¼šUI ç‹€æ…‹åˆ‡æ›ï¼ˆæœªç™»å…¥ vs å·²ç™»å…¥ï¼‰ã€é‡å°å‘è¡Œç‚ºã€‚
- å¾Œç«¯æ¸¬è©¦é‡é»ï¼šOAuth callback å®‰å…¨é©—è­‰ã€JWT ç°½ç™¼/é©—è­‰ã€Cookie è¨­å®šæ­£ç¢ºæ€§ã€‚
- Edge caseï¼štoken éæœŸã€Google å›å‚³éŒ¯èª¤ã€é‡è¤‡è¨»å†Šã€Cookie è¢«æ¸…é™¤ã€‚

### 4.1 Test Strategy Overview

- **Scope**: Google OAuth ç™»å…¥/è¨»å†Šæµç¨‹ã€èªè­‰ç‹€æ…‹ç®¡ç†ã€ç™»å‡ºåŠŸèƒ½
- **Approach**: é¢¨éšªé©…å‹• â€” å„ªå…ˆæ¸¬è©¦å®‰å…¨ç›¸é—œå ´æ™¯ï¼Œå…¶æ¬¡æ˜¯ happy path
- **Environments**: æœ¬æ©Ÿé–‹ç™¼ç’°å¢ƒï¼ˆGoogle OAuth éœ€è¦å¯æ¸¬è©¦çš„ redirect URIï¼‰

### 4.2 Manual Test Cases

| ID | Title | Precondition | Steps | Expected Result | Priority |
|----|-------|--------------|-------|-----------------|----------|
| TC-01 | é¦–æ¬¡ Google ç™»å…¥æˆåŠŸ | æœªç™»å…¥ã€æœªè¨»å†Š | 1. é€²å…¥ /login 2. é»æ“Šã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€ 3. åœ¨ Google åŒæ„æˆæ¬Š | å°å›é¦–é ï¼ŒHeader é¡¯ç¤º Google åç¨±å’Œé ­åƒ | High |
| TC-02 | å·²è¨»å†Šä½¿ç”¨è€… Google ç™»å…¥ | æœ‰å¸³è™Ÿã€æœªç™»å…¥ | 1. é€²å…¥ /login 2. é»æ“Šã€Œä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€ 3. æˆæ¬Š | å°å›é¦–é ï¼Œé¡¯ç¤ºæ­£ç¢ºçš„ä½¿ç”¨è€…è³‡è¨Š | High |
| TC-03 | æ‹’çµ• Google æˆæ¬Š | æœªç™»å…¥ | 1. é€²å…¥ /login 2. é»æ“Šç™»å…¥ 3. åœ¨ Google å–æ¶ˆæˆæ¬Š | å°å›ç™»å…¥é ï¼Œé¡¯ç¤ºã€Œç™»å…¥å·²å–æ¶ˆã€æç¤º | High |
| TC-04 | é é¢é‡æ–°æ•´ç†ä¿æŒç™»å…¥ | å·²ç™»å…¥ | 1. é‡æ–°æ•´ç†é é¢ | ä»ä¿æŒç™»å…¥ï¼ŒHeader é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š | High |
| TC-05 | ç™»å‡ºåŠŸèƒ½ | å·²ç™»å…¥ | 1. é»æ“Šä½¿ç”¨è€…é¸å–® 2. é»æ“Šã€Œç™»å‡ºã€ | æ¸…é™¤ç™»å…¥ç‹€æ…‹ï¼ŒHeader é¡¯ç¤ºã€Œç™»å…¥ã€æŒ‰éˆ• | High |
| TC-06 | æœªç™»å…¥å­˜å– /api/auth/me | ç„¡ Cookie | 1. ç›´æ¥å‘¼å« GET /api/auth/me | å›å‚³ 401 Unauthorized | Medium |
| TC-07 | éæœŸ JWT | JWT å·²éæœŸ | 1. ç­‰å¾… JWT éæœŸ 2. é‡æ–°æ•´ç†é é¢ | å›åˆ°æœªç™»å…¥ç‹€æ…‹ | Medium |
| TC-08 | å¤šç€è¦½å™¨åˆ†é ç™»å…¥ç‹€æ…‹åŒæ­¥ | å·²ç™»å…¥ | 1. é–‹å…©å€‹åˆ†é  2. åœ¨ä¸€å€‹åˆ†é ç™»å‡º 3. é‡æ–°æ•´ç†å¦ä¸€å€‹åˆ†é  | å¦ä¸€å€‹åˆ†é ä¹Ÿè®Šç‚ºæœªç™»å…¥ | Low |

### 4.3 Automation Test Plan

**What to automateï¼š**
- Backend API å–®å…ƒæ¸¬è©¦ï¼ˆJWT ç°½ç™¼/é©—è­‰ã€User CRUDã€Cookie è¨­å®šï¼‰â€” **pytest**
- Backend OAuth callback æ•´åˆæ¸¬è©¦ï¼ˆmock Google APIï¼‰â€” **pytest + httpx mock**
- Frontend å…ƒä»¶æ¸¬è©¦ï¼ˆLoginViewã€UserMenu ç‹€æ…‹åˆ‡æ›ï¼‰â€” **Vitest + Vue Test Utils**
- E2E ç™»å…¥æµç¨‹ â€” **Playwright**ï¼ˆå¯ç”¨ mock OAuth serverï¼‰

**What to keep manualï¼š**
- å¯¦éš› Google OAuth æˆæ¬Šé é¢äº’å‹•ï¼ˆç¬¬ä¸‰æ–¹ UI é›£ä»¥è‡ªå‹•åŒ–ï¼‰
- è·¨ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦

**Suggested test structureï¼š**
```
backend/tests/
â”œâ”€â”€ test_auth.py          # OAuth flow, JWT, login/logout
â”œâ”€â”€ test_user_model.py    # User CRUD operations
â””â”€â”€ conftest.py           # Test fixtures, DB setup

frontend/src/__tests__/
â”œâ”€â”€ useAuth.test.js       # Auth composable unit tests
â”œâ”€â”€ LoginView.test.js     # Login page rendering & interaction
â””â”€â”€ UserMenu.test.js      # User menu rendering & logout
```

### 4.4 Edge Cases & Risk Areas

| # | Edge Case / Risk | Impact | Recommended Test |
|---|------------------|--------|------------------|
| 1 | Google OAuth state ä¸åŒ¹é…ï¼ˆCSRF æ”»æ“Šï¼‰ | High | é©—è­‰ callback æ‹’çµ•ç„¡æ•ˆ state |
| 2 | JWT secret å¤–æ´© | High | ç¢ºä¿ secret å¾ç’°å¢ƒè®Šæ•¸è®€å–ï¼Œä¸ç¡¬ç·¨ç¢¼ |
| 3 | Google å›å‚³ email ç‚ºç©º | Medium | ç¢ºä¿ userinfo ç¼ºå°‘ email æ™‚å›å‚³éŒ¯èª¤ |
| 4 | ä½¿ç”¨è€… Google é ­åƒ URL å¤±æ•ˆ | Low | UserAvatar éœ€æœ‰ fallback é è¨­åœ–ç‰‡ |
| 5 | åŒä¸€ Google å¸³è™Ÿå¿«é€Ÿé€£çºŒç™»å…¥ | Medium | ç¢ºä¿ä¸æœƒå»ºç«‹é‡è¤‡ä½¿ç”¨è€…ï¼ˆUNIQUE ç´„æŸï¼‰ |
| 6 | Cookie SameSite è¨­å®šåœ¨è·¨åŸŸé–‹ç™¼ç’°å¢ƒ | Medium | é–‹ç™¼ç’°å¢ƒ Secure=falseã€SameSite=Lax |

---

## 5. Cross-Role Dependencies & Risks

### 5.1 FE â†” BE API Contract Alignment

| FE Expects | BE Provides | Status |
|------------|-------------|--------|
| `GET /api/auth/google` â†’ 302 redirect | `GET /api/auth/google` â†’ 302 | âœ… Aligned |
| `GET /api/auth/google/callback` â†’ 302 + Set-Cookie | `GET /api/auth/google/callback` â†’ 302 + Set-Cookie | âœ… Aligned |
| `GET /api/auth/me` â†’ `{ id, email, name, avatar_url }` | `GET /api/auth/me` â†’ åŒä¸Š | âœ… Aligned |
| `POST /api/auth/logout` â†’ æ¸…é™¤ Cookie | `POST /api/auth/logout` â†’ æ¸…é™¤ Cookie | âœ… Aligned |
| FE ä½¿ç”¨ `credentials: 'include'` å¸¶ Cookie | BE CORS å·²è¨­å®š `allow_credentials=True` | âœ… Aligned |

### 5.2 Open Questions

1. **Google Cloud Console OAuth Client ç”±èª°å»ºç«‹ï¼Ÿ** â€” DevOps/å¾Œç«¯ â€” ç„¡æ­¤å‰‡ç„¡æ³•é–‹å§‹ OAuth é–‹ç™¼
2. **JWT éæœŸæ™‚é–“ï¼ˆ7 å¤©ï¼‰æ˜¯å¦åˆé©ï¼Ÿ** â€” PO + å®‰å…¨ â€” æ”¯ä»˜æ‡‰ç”¨å¯èƒ½éœ€è¦æ›´çŸ­çš„éæœŸæ™‚é–“
3. **æ˜¯å¦éœ€è¦ refresh token æ©Ÿåˆ¶ï¼Ÿ** â€” å…¨é«” â€” MVP å¯æš«ä¸å¯¦ä½œï¼Œä½†å½±éŸ¿ UX
4. **é–‹ç™¼ç’°å¢ƒçš„ OAuth redirect URI å¦‚ä½•è™•ç†ï¼Ÿ** â€” å¾Œç«¯ â€” éœ€è¦ `localhost:8000` ä½œç‚º authorized redirect URI

### 5.3 Technical Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Google OAuth è¨­å®šéŒ¯èª¤å°è‡´ redirect å¤±æ•— | Medium | High | æå‰å»ºç«‹ Google Cloud å°ˆæ¡ˆä¸¦æ¸¬è©¦ |
| é–‹ç™¼ç’°å¢ƒ Cookie è·¨åŸŸå•é¡Œï¼ˆ5173 â†” 8000ï¼‰ | High | Medium | é–‹ç™¼æ™‚ä½¿ç”¨ Vite proxy æˆ– SameSite=Lax |
| JWT Secret ç®¡ç†ä¸ç•¶ | Low | High | ä½¿ç”¨ .env + .gitignoreï¼Œæ–‡ä»¶èªªæ˜ |

### 5.4 Suggested Spikes

| Spike | Purpose | Timebox |
|-------|---------|---------|
| Google Cloud OAuth è¨­å®š | å»ºç«‹ OAuth Clientã€è¨­å®š redirect URIã€å–å¾— credentials | 2 å°æ™‚ |
| Cookie è·¨åŸŸé–‹ç™¼ç’°å¢ƒé©—è­‰ | ç¢ºèª localhost:5173 â†” localhost:8000 çš„ Cookie å‚³éæ–¹å¼ | 1 å°æ™‚ |

---

## 6. Action Items Summary

| Role | Task | Priority | Estimate | Depends On |
|------|------|----------|----------|------------|
| PO | ç¢ºèª JWT éæœŸæ™‚é–“èˆ‡ refresh token ç­–ç•¥ | P1 | â€” | â€” |
| PO | å»ºç«‹ Google Cloud OAuth Clientï¼Œå–å¾— credentials | P1 | â€” | â€” |
| BE | è¨­å®š PostgreSQL + SQLAlchemy + ç’°å¢ƒè®Šæ•¸ç®¡ç† (BE-1, 2, 3, 10) | P1 | M | Google credentials |
| BE | å¯¦ä½œ OAuth æµç¨‹ + JWT å·¥å…· (BE-4, 5, 6) | P1 | L | BE-1, 2, 3 |
| BE | å¯¦ä½œ /auth/me + /auth/logout + èªè­‰ä¸­ä»‹å±¤ (BE-7, 8, 9) | P1 | M | BE-6 |
| FE | å»ºç«‹ api.js + useAuth composable (FE-1, 2) | P1 | M | BE API å°±ç·’ |
| FE | æ”¹é€  LoginView + GoogleLoginButton (FE-3, 4) | P1 | M | FE-2 |
| FE | æ”¹é€  LoginButton + å»ºç«‹ UserMenu (FE-5, 6, 7) | P1 | M | FE-1 |
| FE | Router èª¿æ•´ + auth åˆå§‹åŒ– + éŒ¯èª¤è™•ç† (FE-8, 9, 10) | P2 | M | FE-1 |
| QA | æ’°å¯« backend pytest æ¸¬è©¦ | P1 | M | BE å®Œæˆ |
| QA | æ’°å¯« frontend Vitest æ¸¬è©¦ | P2 | M | FE å®Œæˆ |
| QA | åŸ·è¡Œæ‰‹å‹•æ¸¬è©¦ TC-01 ~ TC-08 | P1 | M | FE + BE å®Œæˆ |

---

> **Next Steps**: å¯ä½¿ç”¨ `/backend-engineer` skill é–‹å§‹å¯¦ä½œå¾Œç«¯ OAuth æµç¨‹ï¼Œæˆ–ä½¿ç”¨ `/frontend-engineer` skill é–‹å§‹æ”¹é€ ç™»å…¥é é¢ã€‚å»ºè­°å¾Œç«¯å…ˆè¡Œï¼Œå‰ç«¯å†æ¥ä¸Š APIã€‚
